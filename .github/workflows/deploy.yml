name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_bot:
        description: 'Deploy bot service'
        type: boolean
        default: true
      deploy_mcp:
        description: 'Deploy MCP server'
        type: boolean
        default: true

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy-bot:
    name: Deploy Bot Service
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || inputs.deploy_bot

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy
        run: flyctl deploy --config fly.toml --remote-only

  deploy-mcp:
    name: Deploy MCP Server
    runs-on: ubuntu-latest
    needs: deploy-bot
    if: always() && (github.event_name == 'push' || inputs.deploy_mcp)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy
        working-directory: mcp
        run: flyctl deploy --remote-only

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-bot, deploy-mcp]
    if: always() && (needs.deploy-bot.result == 'success' || needs.deploy-mcp.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run deployment smoke tests
        env:
          BOT_URL: https://paty-stage-bot.fly.dev
          MCP_URL: https://paty-stage-mcp.fly.dev
          MCP_API_KEY: ${{ secrets.MCP_API_KEY }}
          BOT_API_KEY: ${{ secrets.BOT_API_KEY }}
        run: uv run pytest tests/smoke/test_deployments.py -v -m smoke
